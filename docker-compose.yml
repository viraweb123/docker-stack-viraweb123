version: "3.7"

networks:
  front-tier:
    name: front-tier
    external: true
  back-tier:
    name: back-tier
    external: true
    
volumes:
  mysql-db:
    external: true
  storage:
    external: true
  logs:
    external: true
  sites-enabled:
    external: true
  sites-certificates:
    external: true
    
services:
  prerender:
    container_name: prerender
    hostname: prerender
    build:
      context: prerender/
    deploy:
      restart_policy:
        condition: on-failure
    labels:
      com.dgyar.title: "Prerender system"
      com.dgyar.description: "Create and manages prerendered pabes"
      com.dgyar.department: "IT"
    environment:
      SERVER_DIR: /root
      CHROME_BIN: /usr/bin/chromium-browser
      CHROME_PATH: /usr/lib/chromium/
      PAGE_DONE_CHECK_INTERVAL: 500
      PAGE_LOAD_TIMEOUT: 20000
      WAIT_AFTER_LAST_REQUEST: 250
    networks:
      - back-tier
    restart: always
  mysql:
    container_name: mysql
    hostname: mysql
    build:
      context: mysql/
    deploy:
      restart_policy:
        condition: on-failure
    labels:
      com.dgyar.description: "Data node"
      com.dgyar.department: "IT"
    command: --sql_mode=""
    environment:
      MYSQL_ROOT_PASSWORD: P@ssw0rd
      MYSQL_DATABASE: plufdb
      MYSQL_USER: pluf
      MYSQL_PASSWORD: password
      MYSQL_ROOT_HOST: '%'
    networks:
      - back-tier
    volumes:
      - type: volume
        source: mysql-db
        target: /var/lib/mysql
    restart: always
  pluf:
    container_name: pluf
    hostname: pluf
    build:
      context: pluf/
    deploy:
      restart_policy:
        condition: on-failure
    labels:
      com.dgyar.description: "Public webapp interface"
      com.dgyar.department: "IT"
    volumes:
      - type: volume
        source: storage
        target: /var/www/storage
      - type: volume
        source: logs
        target: /var/www/logs
      - type: volume
        source: sites-enabled
        target: /etc/apache2/sites-enabled
      - type: volume
        source: sites-certificates
        target: /etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"
    networks:
      - front-tier
      - back-tier
    depends_on:
      - mysql
      - prerender
#  dms:
#    build:
#      context: dms/
#    deploy:
#      restart_policy:
#        condition: on-failure
#    labels:
#      com.dgyar.title: "Domain management system"
#      com.dgyar.description: "Create and manages certificates, domains, and dns"
#      com.dgyar.department: "IT"
#    networks:
#      - back-tier
#    volumes:
#      - type: volume
#        source: plufStorage-vol
#        target: /var/www/storage
#      - type: volume
#        source: sites-enabled-vol
#        target: /var/www/sites-enabled
#    restart: always


